<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./assets/images/favicon/favicon.ico"/>

    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/home/main.css">
    <link rel="stylesheet" href="./assets/css/transaction/transaction.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/home/footer.css">
    <link rel="stylesheet" href="./assets/css/cart/cart.css">

    <title>View Cart</title>
    <script src="./assets/js/cart.js">
    </script>
</head>
<body>
<div class="shop">
    <header class="header">
        <div class="grid">
            <div class="header_navbar">
                <a href="./home.html">
                    <div class="logo">
                        <img src="./assets/images/logo/logo.png" alt="logo">
                    </div>
                </a>
                <div class="menu_wrap">
                    <div class="main_menu">
                        <ul class="menu_list">
                            <li class="menu_item">
                                <a href="./home.html">HOME</a>
                            </li>
                            <li class="menu_item men">
                                <a href="./men.html">MEN</a>
                            </li>
                            <li class="menu_item women">
                                <a href="./women.html">WOMEN</a>
                            </li>
                            <li class="menu_item contact">
                                <a href="./contact.html">CONTACT</a>
                            </li>
                            <li class="menu_item">
                                <a class="aboutus" href="./aboutus.html">ABOUT US</a>
                            </li>
                            <li class="menu_item">
                                <a href="./order_history.html" style="white-space: nowrap;">ORDER HISTORY</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="transaction_title_area">
        <div class="transaction_container">
            <div class="col_left">
                <h2>Your Cart</h2>
            </div>
            <div class="col_right">
                <ul class="list_nav">
                    <li><a href="./home.html">Home</a></li>
                    <li><span>View Cart </span></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="cart_page_area">
        <div class="cart_page_container">
            <div class="cart_title">
                <h2>Your Current Order</h2>
            </div>

            <div id="board">
                <h3 style="font-size: 20px;">Your cart is empty</h3>
            </div>

            <div class="cart_continue">
                <!-- Choose next action  -->
                <div class="continue_shopping home_button" style="cursor:pointer;"
                     onclick="(()=>{window.location.href = './home.html'})()"
                >
                    <a href="./home.html" style="text-decoration: none;color: #ffffff;">Continue Shopping</a>
                </div>
                <div class="continue_shopping transaction_button"
                     style="float: right;position: relative;cursor:pointer;"
                     onclick="handleMoving()"
                >
                    <a style="text-decoration: none;color: #ffffff;">Check Out</a>
                </div>
            </div>
        </div>

    </div>


    <footer class="footer">
        <div class="footer-container">
            <div class="footer_container_info">
                <div class="single_footer">
                    <h4>CONTACT</h4>
                    <ul>
                        <li>4060 Reppert Coal Road, MS</li>
                        <li>39201 USA</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
                <div class="single_footer">
                    <h4>INFORMATION</h4>
                    <ul>
                        <li>About us</li>
                        <li>Delivery Information</li>
                        <li>Privacy Policy</li>
                        <li>Terms & Conditions</li>
                        <li>Contact us</li>
                    </ul>
                </div>
                <div class="single_footer service">
                    <h4>Service</h4>
                    <ul>
                        <li>My Account</li>
                        <li>Return</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
            </div>
            <div class="footer_btm_area">
                <div class="footer_social_icon">
                    <ul class="footer_social_icon_list">
                        <li><a href=""><i class="fab fa-facebook-f"></i></a></li>
                        <li><a href=""><i class="fab fa-google"></i></a></li>
                        <li><a href=""><i class="fab fa-linkedin"></i></a></li>
                        <li><a href=""><i class="fab fa-twitter"></i></a></li>
                        <li><a href=""><i class="fas fa-rss"></i></a></li>
                    </ul>
                </div>
                <div class="footer_copyright">
                    <p class="copyright_text">Â© 2021 All Rights Reserved FancyShop</p>
                </div>
                <div class="footer_payment_icon">
                    <ul class="footer_payment_icon_list">
                        <li><a href=""><i class="fab fa-cc-paypal"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-visa"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-discover"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-mastercard"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-amex"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</div>


<script>
    const parseCookie = str => {
        if (str === '') {
            return {}
        }
        return str
            .split(';')
            .map(v => v.split('='))
            .reduce((acc, v) => {
                acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
                return acc;
            }, {});
    }

    const structuredCookie = parseCookie(document.cookie)
    const token = structuredCookie['token']

    function deleteCookie(path) {
        document.cookie = `token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/${path || ''}`;
    }

    const handleRemove = (product_id, receipt_id, color, size) => {
        console.log(product_id, receipt_id, color, size)

        return fetch('/order', {
            method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
            body: JSON.stringify({
                product_id: product_id, receipt_id: receipt_id, color: color, size: size
            })
        }).then(x => {
            if (x.status >= 400) {
                if (x.status == 401) {
                    //unauthorized. Maybe out of session
                    deleteCookie()
                }
                throw new Error(x.statusText)
            }
            console.log(x)
            document.location.replace(document.location.href)
        }).catch(err => {
            alert(err.toString())
            return null
        })
    }

    async function getCurrentCart() {
        return fetch('/get_cart_id', {
            method: 'GET', // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        }).then(x => {
            if (x.status >= 400) {
                if (x.status == 401) {
                    //unauthorized. Maybe out of session
                    deleteCookie()
                    alert('Your session has ended. Please log in again')
                    document.location.replace('/home.html')
                }
                throw new Error(x.statusText)
            }
            return x.json()
        }).catch(err => {
            alert(err.toString())
            return null
        })
    }

    let canMoveOnFlag = true

    async function start() {
        if (!structuredCookie['token']) {
            alert('You must login')
            setTimeout(() => document.location.replace('/login.html'), 200)
            return;
        }

        const cart = await getCurrentCart()
        if (!cart) {
            return
        }
        console.log(cart)

        const b = document.querySelector('#board')


        if (cart.length === 0) {
            b.style.border = 'none'
            b.style['background-color'] = '#ffffff'
            document.querySelector('.home_button').style['margin-left'] = '27%'
            document.querySelector(`.transaction_button`).remove()
        } else {

            b.innerHTML = (`
            ${cart.reduce((acc, cur) => {
                const isNotAvailable = !cur.available
                if (isNotAvailable) {
                    canMoveOnFlag = false
                }

                return acc + `
                <div class="a_product ${isNotAvailable ? 'expired' : ''}">
                    <div class='product_infor'>
                        <img class='product_img' src='${cur.big_image_link}'>
                        <div class='product_detail'>
                            <h2 class='product_title' style="line-height: 23px">${cur.product_name}</h2>
                            <p class='color_display' >Color: <span class='color_product'>${cur.color}</span></p>
                            <p class='size_display' >Size: <span class='size_product'>${cur.size}</span></p>
                        </div>
                    </div>
                    <div class='product_price'>
                        <h2 class="price_tag">Price($)</h2>
                        <p class='price'>$${cur.price.toFixed(2)}</p>
                    </div>
                    <div class='product_quantity'>
                        <h2 class="quantity_tag">Quantity</h2>
                        <p class='quantity'>${!isNotAvailable ? cur.quantity : '<span class="warning-sight">This product is out of stock. Please remove it before you continue.</span>'}</p>
                    </div>
                    <div class='btn_delete'>
                        <button class='remove' style="padding: 5px;" onclick="handleRemove(${cur.product_id}, ${cur.receipt_id}, '${cur.color}', '${cur.size}')">Remove</button>
                    </div>
                </div>
                `
            }, '')}

            `)
            if (!canMoveOnFlag) {
                document.querySelector('.transaction_button').classList.add('no-go-button')
            }
            handleChangeWith(document.documentElement.clientWidth)
        }
    }

    start()

    function handleMoving() {
        if (canMoveOnFlag) {
            window.location.href = './transaction.html'
        } else {
            alert('Your cart contains out of stock products. Please remove them before continue.')
        }
    }
</script>


<script>

    const changeVisibility = (classNames, value, all = false) => {
        if (all === false) {
            classNames.forEach(className => {
                console.log(className)
                document.querySelector(`.${className}`).style.display = value ? 'initial' : 'none'
            })
        } else {
            classNames.forEach(className => {
                document.querySelectorAll(`.${className}`).forEach(e => {
                    e.style.display = value ? 'initial' : 'none'
                })
            })
        }
    }

    const handleChangeWith = (width) => {
        console.log(width)
        if (width <= 575) {

            document.querySelectorAll('.header_navbar').forEach(e => {
                e.style.display = 'block'
            })
            document.querySelectorAll('.menu_list').forEach(e => {
                e.style.overflow = 'scroll'
                e.style.justifyContent = 'flex-start'
            })

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '0px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 10px';
            })

            document.querySelector('.col_left').style['padding-left'] = '10px'

            document.querySelectorAll('.footer_btm_area').forEach(e => {
                e.style.display = 'block'
            })
            document.querySelectorAll('.footer_copyright, .footer_payment_icon').forEach(e => {
                e.style['margin-top'] = '16px'
            })
            document.querySelectorAll('.product_item_list').forEach(e => {
                e.style['width'] = 'auto'
            })
            changeVisibility(['women', 'men'], false)

            changeVisibility(['service'], false)
        } else if (width <= 1151) {
            document.querySelectorAll('.header_navbar').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.menu_list').forEach(e => {
                e.style.overflow = 'scroll'
                e.style.justifyContent = 'space-around'
            })

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['line-height'] = '80px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 20px';
            })

            document.querySelector('.col_left').style['padding-left'] = '10px'

            document.querySelectorAll('.footer_btm_area').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.footer_copyright, .footer_payment_icon').forEach(e => {
                e.style['margin-top'] = '0px'
            })

            changeVisibility(['service'], true)

            changeVisibility(['women', 'men'], false)
            document.querySelector('.col_left').style['padding-left'] = '10px'

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '0px'
            })

            document.querySelectorAll('.product_title').forEach(e => {
                e.style['font-size'] = '13px'
            })

            // document.querySelectorAll('.color_product').forEach(e => {
            //     e.style['font-size'] = '13px'
            // })
            document.querySelector('.cart_page_area').style['padding-left'] = '0'
            document.querySelector('.cart_page_area').style['padding-right'] = '0'


            document.querySelectorAll('.pic>img').forEach(e => {
                e.style['height'] = 'auto'
            })


            document.querySelectorAll('.price_tag').forEach(e => {
                e.style['font-size'] = '16px'
            })

            document.querySelectorAll('.quantity_tag').forEach(e => {
                e.style['font-size'] = '16px'
            })

            document.querySelectorAll('.color_display').forEach(e => {
                e.style['margin-top'] = '5px'
            })
            document.querySelectorAll('.size_display').forEach(e => {
                e.style['margin-top'] = '5px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 10px';
            })


            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'none'
            })
            document.querySelectorAll('.continue_shopping').forEach(e => {
                e.style['width'] = 'auto'
            })
        } else {
            changeVisibility(['women', 'men'], true)
            //sign in-up
            document.querySelector('.col_left').style['padding-left'] = '0px'

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '1px'
            })

            document.querySelectorAll('.price_tag').forEach(e => {
                e.style['font-size'] = '18px'
            })

            document.querySelectorAll('.quantity_tag').forEach(e => {
                e.style['font-size'] = '18px'
            })

            document.querySelectorAll('.color_display').forEach(e => {
                e.style['margin-top'] = '7px'
            })

            document.querySelectorAll('.size_display').forEach(e => {
                e.style['margin-top'] = '7px'
            })
            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 20px'
            })

            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.pic>img').forEach(e => {
                e.style['height'] = '382px'
            })


            document.querySelectorAll('.continue_shopping').forEach(e => {
                e.style['width'] = '15%'
            })

            document.querySelector('.cart_page_area').style['padding-left'] = '10%'
            document.querySelector('.cart_page_area').style['padding-right'] = '10%'

        }
    }

    window.addEventListener('resize', (window) => {
        const {clientWidth: width} = document.documentElement
        handleChangeWith(width)
    })

    console.log(document.documentElement.clientWidth)
    handleChangeWith(document.documentElement.clientWidth)

</script>

</body>

<style>
    .expired {
        background: #F54748;
    }

    .no-go-button {
        background: black !important;
        opacity: 60%;
    }

    .warning-sight {
        font-size: 14px;
        color: wheat;
        font-weight: 600;
    }

    @media only screen and (max-width: 575px) {
        .cart_page_area {
            padding-left: 0;
            padding-right: 0;
            width: auto;
        }

        .color_display, .size_display, .product_quantity, .product_price {
            display: none;
        }

        .product_title {
            font-size: 16px;
        }

        .product_infor {
            width: 75%;
        }

        .remove {
            margin-left: 10px;
        }

        .home, .men, .women {
            display: block !important;
        }
    }
</style>
</html>
