<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/home/main.css">
    <link rel="stylesheet" href="./assets/css/men/men.css">
    <link rel="stylesheet" href="./assets/css/home/product_area.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/home/footer.css">
    <link rel="icon" href="./assets/images/favicon/favicon.ico"/>

    <title class="top-title">Category</title>

</head>
<body>
<div class="shop">
    <header class="header">
        <div class="grid">
            <div class="header_navbar">
                <a href="./home.html">
                    <div class="logo">
                        <img src="./assets/images/logo/logo.png" alt="logo">
                    </div>
                </a>
                <div class="menu_wrap">
                    <div class="main_menu">
                        <ul class="menu_list">
                            <li class="menu_item  home">
                                <a href="./home.html">HOME</a>
                            </li>
                            <li class="menu_item men">
                                <a href="./category.html?category_id=1">MEN</a>
                            </li>
                            <li class="menu_item women">
                                <a href="./category.html?category_id=2">WOMEN</a>
                            </li>
                            <li class="menu_item">
                                <a href="./contact.html">CONTACT</a>
                            </li>
                            <li class="menu_item">
                                <a class="aboutus" href="./aboutus.html">ABOUT US</a>
                            </li>
                            <li class="menu_item cart_button">
                                <a href="./cart_page.html">CART</a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="sign_in_up">
                    <div class="sign_up">
                        <a href="./signup.html">
                            <h3>SIGN UP</h3>
                        </a>
                    </div>
                    <div class="sign_in">
                        <a href="./login.html">
                            <h3>SIGN IN</h3>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="men_title_area">
        <div class="men_container">
            <div class="col_left">
                <h2 class="page_name"></h2>
            </div>
            <div class="col_right">
                <ul class="list_nav">
                    <li><a href="./home.html">Home</a></li>
                    <li><span class="breadcrumb_location">Men</span></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="content">

        <div style="margin: 0 20px 20px 97px;" class="search_container">
            <input type="text" placeholder="Search for something"
                   class="search_value" oninput="handleSearch()" style="padding: 5px 7px;"/>
        </div>

        <div class="product_item">
            <div class="product_item_list">
                <div class="product_item_container">

                </div>
                <div class="naviagte-buttons">
                    <div class="navigate-left">
                        <button class="control-button cb-left" onclick="toLastPage()"> <</button>
                    </div>
                    <div class="navigate-right">
                        <button class="control-button cb-right" onclick="toNextPage()"> ></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="footer-container">
            <div class="footer_container_info">
                <div class="single_footer">
                    <h4>CONTACT</h4>
                    <ul>
                        <li>4060 Reppert Coal Road, MS</li>
                        <li>39201 USA</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
                <div class="single_footer">
                    <h4>INFORMATION</h4>
                    <ul>
                        <li>About us</li>
                        <li>Delivery Information</li>
                        <li>Privacy Policy</li>
                        <li>Terms & Conditions</li>
                        <li>Contact us</li>
                    </ul>
                </div>
                <div class="single_footer">
                    <h4>Service</h4>
                    <ul>
                        <li>My Account</li>
                        <li>Return</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
            </div>
            <div class="footer_btm_area">
                <div class="footer_social_icon">
                    <ul class="footer_social_icon_list">
                        <li><a href=""><i class="fab fa-facebook-f"></i></a></li>
                        <li><a href=""><i class="fab fa-google"></i></a></li>
                        <li><a href=""><i class="fab fa-linkedin"></i></a></li>
                        <li><a href=""><i class="fab fa-twitter"></i></a></li>
                        <li><a href=""><i class="fas fa-rss"></i></a></li>
                    </ul>
                </div>
                <div class="footer_copyright">
                    <p class="copyright_text">Â© 2021 All Rights Reserved FancyShop</p>
                </div>
                <div class="footer_payment_icon">
                    <ul class="footer_payment_icon_list">
                        <li><a href=""><i class="fab fa-cc-paypal"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-visa"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-discover"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-mastercard"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-amex"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
    const serialize = function (obj) {
        const str = [];
        for (let p in obj)
            if (obj.hasOwnProperty(p)) {
                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
            }
        return str.join("&");
    }

    const capitalize = (str) => str && str.length > 0 ? str[0].toUpperCase() + str.slice(1,) : ''

    const url = new URL(window.location)

    const get_products = async (sortby, search) => {
        const page_number = url.searchParams.get('page') || 0
        const offset = search ? 0 : page_number * 20;
        return fetch(`/products?offset=${offset}${sortby ? `&sortby=${sortby}` : ''}${search ? `&search=${search}` : ''}`, {
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json'
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer',
        })
            .then(x => x.json())
            .then(x => {
                if (x.error) {
                    return undefined
                }
                return x
            }).catch(err => {
                return null
            })
    }

    const toLastPage = () => {
        const url_ob = new URL(location.href)
        const current_page = url_ob.searchParams.get('page') || 0
        url_ob.searchParams.set('page', Number.parseInt(current_page) - 1)
        window.location.href = url_ob.href
    }

    const toNextPage = () => {
        const url_ob = new URL(location.href)
        const current_page = url_ob.searchParams.get('page') || 0
        url_ob.searchParams.set('page', Number.parseInt(current_page) + 1)
        window.location.href = url_ob.href
    }


    let requestor = null

    const handleSearch = async () => {
        const url_ob = new URL(location.href)
        const sortby = url_ob.searchParams.get('sortby') || 0
        const search_value = document.querySelector('.search_value').value

        if (requestor) {
            clearTimeout(requestor)
        }

        requestor = setTimeout(() => {
            document.querySelector('.cb-right').style.display = 'none'
            document.querySelector('.cb-left').style.display = 'none'

            get_products(sortby, search_value).then(products => {
                console.log(products)
                console.log('123')
                const p = document.querySelector('.product_item_container')

                if (!search_value) {
                    const url_ob = new URL(location.href)
                    const current_page = url_ob.searchParams.get('page') || 0

                    if (Number.parseInt(current_page) !== 0) {
                        document.querySelector('.cb-left').style.display = 'initial'
                    }

                    if (products.length >= 20) {
                        //no more
                        document.querySelector('.cb-right').style.display = 'initial'
                    }
                }

                // if (products.length < 20) {
                //     //no more
                //     document.querySelector('.cb-right').style.display = 'none'
                // }

                p.innerHTML = ''

                products.forEach(product => {
                    const pres = document.createElement("div")
                    pres.className = "single_product"
                    pres.innerHTML = `
                        <div class="product_image product_view_${product.id}">
                            <a href="/product.html?product_id=${product.id}">
                                <img src="${product.big_image_link}" alt="">
                                <div class="box_content">
                                    <div class="men_box_content_icon">
                                        <a href="#"><i class="far fa-heart"></i></a>
                                    </div>
                                    <div class="men_box_content_icon">
                                        <a href="/product.html?product_id=${product.id}"><i class="fas fa-cart-plus"></i></a>
                                    </div>
                                    <div class="men_box_content_icon">
                                        <a href="#"><i class="fas fa-search"></i></a>
                                    </div>
                                </div>

                                <div class="product_text_info">
                                    <h4>
                                        <a href="/product.html?product_id=${product.id}" class="product_title">${product.name}</a>
                                    </h4>
                                    <span class="price">$${(product.price).toFixed(2)}</span>
                                </div>
                            </a>
                        </div>
                `

                    p.appendChild(pres)
                })
            }).catch(err => {
                console.warn(err)
            })
        }, 500)

    }

    const parseCookie = str => {
        if (str === '') {
            return {}
        }
        return str
            .split(';')
            .map(v => v.split('='))
            .reduce((acc, v) => {
                acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
                return acc;
            }, {});
    }

    function loginUpperBar() {
        document.querySelector('.sign_in_up').innerHTML = `
        <div class="log_out">
            <a onclick="handleLogout()">
                <h3>Log out</h3>
            </a>
        </div>
        `
    }

    const start = async () => {
        const structuredCookie = parseCookie(document.cookie)
        const isLogin = !!structuredCookie['token']

        if (isLogin) {
            loginUpperBar()
            document.querySelector('.cart_button').style.display = 'initial'
        } else {
            document.querySelector('.cart_button').style.display = 'none'
        }

        const url_ob = new URL(location.href)
        const current_page = url_ob.searchParams.get('page') || 0
        const sortby = url_ob.searchParams.get('sortby') || 0


        const title = capitalize(url_ob.searchParams.get('title')) || 'Products'
        document.querySelector('.top-title').innerText = title
        document.querySelector('.breadcrumb_location').innerText = title.toUpperCase()


        if (Number.parseInt(current_page) === 0) {
            document.querySelector('.cb-left').style.display = 'none'
        }

        document.querySelector('.page_name').innerText = title

        const products = await get_products(sortby)

        const p = document.querySelector('.product_item_container')

        if (products.length < 20) {
            //no more
            document.querySelector('.cb-right').style.display = 'none'
        }


        //TODO: handle button clicks
        products.forEach(product => {
            const pres = document.createElement("div")
            pres.className = "single_product"
            pres.innerHTML = `
                        <div class="product_image product_view_${product.id}">
                            <a href="/product.html?product_id=${product.id}">
                                <img src="${product.big_image_link}" alt="">
                                <div class="box_content">
                                    <div class="men_box_content_icon">
                                        <a href="#"><i class="far fa-heart"></i></a>
                                    </div>
                                    <div class="men_box_content_icon">
                                        <a href="/product.html?product_id=${product.id}"><i class="fas fa-cart-plus"></i></a>
                                    </div>
                                    <div class="men_box_content_icon">
                                        <a href="#"><i class="fas fa-search"></i></a>
                                    </div>
                                </div>

                                <div class="product_text_info">
                                    <h4>
                                        <a href="/product.html?product_id=${product.id}" class="product_title">${product.name}</a>
                                    </h4>
                                    <span class="price">$${(product.price).toFixed(2)}</span>
                                </div>
                            </a>
                        </div>
                `

            p.appendChild(pres)
            handleChangeWith(document.documentElement.clientWidth)
        })
    }

    start();


</script>


<script>

    const changeVisibility = (classNames, value, all = false) => {
        if (all === false) {
            classNames.forEach(className => {
                console.log(className)
                document.querySelector(`.${className}`).style.display = value ? 'initial' : 'none'
            })
        } else {
            classNames.forEach(className => {
                document.querySelectorAll(`.${className}`).forEach(e => {
                    e.style.display = value ? 'initial' : 'none'
                })
            })
        }
    }

    const handleChangeWith = (width) => {
        console.log(width)
        if (width <= 760) {
            changeVisibility(['women', 'men'], false)
            document.querySelector('.product_item_list').style.width = 'auto'
            if (document.querySelector('.sign_up')) {
                document.querySelector('.sign_up').style['margin-left'] = '0px'
                document.querySelector('.sign_up').style['margin-right'] = '10px'
            }
            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '0px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 10px';
            })


            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'none'
            })
            document.querySelector('.col_left').style['padding-left'] = '10px'
            document.querySelector('.product_item_container').style['padding'] = '10px'
            document.querySelector('.search_container').style['margin'] = '0 20px 20px 10px'

            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'none'
            })
        } else {
            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelector('.search_container').style['margin'] = '0 20px 20px 97px'

            document.querySelector('.product_item_container').style['padding'] = '0px'

            document.querySelector('.col_left').style['padding-left'] = '0px'

            changeVisibility(['women', 'men'], true)
            // product list
            document.querySelector('.product_item_list').style.width = '1160px'

            //sign in-up
            if (document.querySelector('.sign_up')) {
                document.querySelector('.sign_up').style['margin-left'] = '50px'
                document.querySelector('.sign_up').style['margin-right'] = '20px'
            }

            document.querySelector('.col_left').style['padding-left'] = '0px'

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '1px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 20px'
            })

            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'flex'
            })
        }
    }

    window.addEventListener('resize', (window) => {
        const {clientWidth: width} = document.documentElement
        handleChangeWith(width)
    })

    console.log(document.documentElement.clientWidth)
    handleChangeWith(document.documentElement.clientWidth)

</script>
</body>
</html>