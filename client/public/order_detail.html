<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/home/main.css">
    <link rel="stylesheet" href="./assets/css/transaction/transaction.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/home/footer.css">
    <link rel="icon" href="./assets/images/favicon/favicon.ico"/>

    <title>Order Detail</title>

</head>
<body>
<div class="shop">
    <header class="header">
        <div class="grid">
            <div class="header_navbar">
                <a href="./home.html">
                    <div class="logo">
                        <img src="./assets/images/logo/logo.png" alt="logo">
                    </div>
                </a>
                <div class="menu_wrap">
                    <div class="main_menu">
                        <ul class="menu_list">
                            <li class="menu_item home">
                                <a href="./home.html">HOME</a>
                            </li>
                            <li class="menu_item men">
                                <a href="./men.html">MEN</a>
                            </li>
                            <li class="menu_item women">
                                <a href="./women.html">WOMEN</a>
                            </li>
                            <li class="menu_item">
                                <a href="./contact.html">CONTACT</a>
                            </li>
                            <li class="menu_item">
                                <a class="aboutus" href="./aboutus.html">ABOUT US</a>
                            </li>
                            <li class="menu_item">
                                <a href="./cart_page.html">CART</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="transaction_title_area">
        <div class="transaction_container">
            <div class="col_left">
                <h2>Order Details</h2>
            </div>
            <div class="col_right">
                <ul class="list_nav">
                    <li><a href="./home.html">Home</a></li>
                    <li><span>ORDER DETAILS</span></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="transaction_page_area">
        <div class="transaction_page_container">
            <div class="billing_details">
                <div class="billing_title">
                    <h3>Billing Details</h3>
                </div>
                <form class="form_input">
                    <div class="form-row">
                        <div class="single-row">
                            <input name="first_name" placeholder="First name"
                                   class="form-control first_name"
                                   type="text" disabled>
                        </div>
                        <div class="single-row">
                            <input name="last_name" placeholder="Last name"
                                   class="form-control last_name"
                                   type="text" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <input name="company_name" placeholder="Company name"
                               class="form-control company_name"
                               type="text" disabled>
                    </div>
                    <div class="form-row">
                        <div class="single-row">
                            <input name="email_address"
                                   placeholder="Email address"
                                   class="form-control email_address" type="text" disabled>
                        </div>
                        <div class="single-row">
                            <input name="phone_number" placeholder="Phone Number"
                                   class="form-control phone_number" type="text" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="country">Country:</label>
                        <div class="custom-select-wrapper">
                            <select id="country" class="custom-select country" disabled>
                                <option value="canada">Canada *</option>
                                <option value="american">American</option>
                                <option value="australia">Australia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Address:</label>
                        <textarea rows="3" name="street"
                                  id="address" placeholder="Street address. Apartment, suite, unit etc. (optional)"
                                  class="form-control address" disabled></textarea>
                    </div>
                    <div class="form-row">
                        <div class="single-row">
                            <input name="postcode" placeholder="Post Code/Zip"
                                   class="form-control postcode"
                                   type="text" disabled>
                        </div>
                        <div class="single-row">
                            <input name="city" placeholder="Town/City"
                                   class="form-control city" type="text" disabled>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address">Order note:</label>
                        <textarea rows="3" name="note"
                                  placeholder="Order note"
                                  class="form-control note"
                                  style="min-height: 140px;" disabled></textarea>

                    </div>
                </form>
            </div>
            <div class="your_order">
                <div class="your_order_title">
                    <h3>Your Order</h3>
                </div>
                <div class="table_of_order">
                    <table class="table-order">
                        <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Total</th>
                        </tr>
                        </thead>
                        <tbody>

                        </tbody>
                        <tfoot>
                        <tr>
                            <td><b>Total</b></td>
                            <td class="total_amount price_value"></td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="payment-method">
                    <input type="hidden" value="" class="hidden_payment_method"/>
                    <ul>
                        <li>
                            <div class="custom-radio">
                                <input type="radio" id="customRadio1" name="customRadio" class="custom-control-input"
                                       value="bank" onclick="handleChangeRadio('bank')" disabled>
                                <label class="custom-control-label radio_value" for="customRadio1">Direct Bank
                                    Transfer</label>
                                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris sed lobortis sem.
                                    Quisque at
                                    sapien ut odio</p>
                            </div>
                        </li>
                        <li>
                            <div class="custom-radio" style="margin-top: 10%;">
                                <input type="radio" id="customRadio2" name="customRadio" class="custom-control-input"
                                       value="paypal" onclick="handleChangeRadio('paypal')" disabled>
                                <label class="custom-control-label radio_value" for="customRadio2">PayPal</label>
                            </div>

                        </li>
                    </ul>
                </div>
                <button class="button-place-order" onclick="(()=>{window.location.href='./order_history.html'})()">
                    <span style="text-decoration: none;color: #ffffff;">Go back</span>
                </button>
            </div>
        </div>

    </div>
    <footer class="footer">
        <div class="footer-container">
            <div class="footer_container_info">
                <div class="single_footer">
                    <h4>CONTACT</h4>
                    <ul>
                        <li>4060 Reppert Coal Road, MS</li>
                        <li>39201 USA</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
                <div class="single_footer">
                    <h4>INFORMATION</h4>
                    <ul>
                        <li>About us</li>
                        <li>Delivery Information</li>
                        <li>Privacy Policy</li>
                        <li>Terms & Conditions</li>
                        <li>Contact us</li>
                    </ul>
                </div>
                <div class="single_footer service">
                    <h4>Service</h4>
                    <ul>
                        <li>My Account</li>
                        <li>Return</li>
                        <li>(+123) 685 78</li>
                        <li>(+123) 685 78</li>
                        <li>Contact@yourcompany.com</li>
                    </ul>
                </div>
            </div>
            <div class="footer_btm_area">
                <div class="footer_social_icon">
                    <ul class="footer_social_icon_list">
                        <li><a href=""><i class="fab fa-facebook-f"></i></a></li>
                        <li><a href=""><i class="fab fa-google"></i></a></li>
                        <li><a href=""><i class="fab fa-linkedin"></i></a></li>
                        <li><a href=""><i class="fab fa-twitter"></i></a></li>
                        <li><a href=""><i class="fas fa-rss"></i></a></li>
                    </ul>
                </div>
                <div class="footer_copyright">
                    <p class="copyright_text">© 2021 All Rights Reserved FancyShop</p>
                </div>
                <div class="footer_payment_icon">
                    <ul class="footer_payment_icon_list">
                        <li><a href=""><i class="fab fa-cc-paypal"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-visa"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-discover"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-mastercard"></i></a></li>
                        <li><a href=""><i class="fab fa-cc-amex"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
</div>

<script>
    const parseCookie = str => {
        if (str === '') {
            return {}
        }
        return str
            .split(';')
            .map(v => v.split('='))
            .reduce((acc, v) => {
                acc[decodeURIComponent(v[0].trim())] = decodeURIComponent(v[1].trim());
                return acc;
            }, {});
    }

    const structuredCookie = parseCookie(document.cookie)
    const token = structuredCookie['token']
    let receiptData = null

    function handleChangeRadio(name) {
        const s = document.querySelector('.hidden_payment_method')
        if (name === 'bank') {
            s.value = 'bank'
        } else if (name === 'paypal') {
            s.value = 'paypal'
        }
    }

    async function fillData(o) {
        if (receiptData === null) {
            alert('Invalid receipts')
            return;
        }

        const {
            billing_first_name: first_name = '',
            billing_last_name: last_name = '',
            company_name: company_name = '',
            email: email_address = '',
            phone_number: phone_number = '',
            country: country = '',
            address: address = '',
            postcode: postcode = '',
            city: city = '',
            note: note = '',
            payment_method: hidden_payment,
            products = []
        } = o

        console.log(o)


        document.querySelector('.first_name').value = first_name
        document.querySelector('.last_name').value = last_name
        document.querySelector('.company_name').value = company_name
        document.querySelector('.email_address').value = email_address
        document.querySelector('.phone_number').value = phone_number
        document.querySelector('.country').value = country
        document.querySelector('.address').value = address
        document.querySelector('.postcode').value = postcode
        document.querySelector('.city').value = city
        document.querySelector('.note').value = note

        if (hidden_payment === 'bank') {
            document.querySelector('#customRadio1').checked = true
        } else {
            document.querySelector('#customRadio2').checked = true
        }

        const p = document.querySelector('.table-order > tbody')

        const close_cart = products.reduce((acc, cur) => {
            if (!acc[cur.product_id]) {
                acc[cur.product_id] = {
                    name: cur.product_name,
                    price: cur.quantity * cur.price
                }
            } else {
                acc[cur.product_id].price += cur.quantity * cur.price
            }
            return acc
        }, {})

        p.innerHTML = (`
        ${Object.values(close_cart).reduce((acc, item) => {
            return acc + `
                        <tr>
                            <td>${item.name}</td>
                            <td class="price_value">$${item.price.toFixed(2)}</td>
                        </tr>
`
        }, '')}
        `)

        const total = Object.values(close_cart).reduce((acc, cur) => acc + cur.price, 0)
        document.querySelector('.total_amount').innerText = `$${total.toFixed(2)}`

    }

    function deleteCookie(path) {
        document.cookie = `token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/${path || ''}`;
    }

    async function getOrderDetails(id) {
        return fetch(`/order/${id}`, {
            method: 'GET', // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        }).then(x => {
            if (x.status === 401) {
                //unauthorized. Maybe out of session
                deleteCookie()
                alert('Your session has ended. Please login to continue.')
                document.location.href = '/login.html'
            }
            if (x.status === 404) {
                document.location.replace('./404.html')
            }
            return x.json()
        }).then(x => {
            if (x && x.error) {
                throw new Error(x.error)
            }
            return x
        }).catch(err => {
            alert(err.message)
            return null
        })
    }

    async function start() {
        const structuredCookie = parseCookie(document.cookie)

        if (!structuredCookie['token']) {
            deleteCookie()
            alert('Your session has ended. Please login to continue.')
            document.location.href = '/login.html'
            return;
        }

        const current_url = new URL(window.location.href)

        const id = current_url.searchParams.get('receipt_id')
        const receipt = await getOrderDetails(id)

        console.log(receipt)
        if (!receipt) {
            return
        }
        receiptData = receipt.length > 0 ? receipt[0] : null

        if (!receiptData) {
            return
        }
        fillData(receiptData)
    }

    start()

</script>


<script>

    const changeVisibility = (classNames, value, all = false) => {
        if (all === false) {
            classNames.forEach(className => {
                console.log(className)
                document.querySelector(`.${className}`).style.display = value ? 'initial' : 'none'
            })
        } else {
            classNames.forEach(className => {
                document.querySelectorAll(`.${className}`).forEach(e => {
                    e.style.display = value ? 'initial' : 'none'
                })
            })
        }
    }

    const handleChangeWith = (width) => {
        console.log(width)
        if (width <= 635) {
            document.querySelectorAll('.header_navbar').forEach(e => {
                e.style.display = 'block'
            })
            document.querySelectorAll('.menu_list').forEach(e => {
                e.style.overflow = 'scroll'
                e.style.justifyContent = 'flex-start'
            })

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '0px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 10px';
            })

            document.querySelector('.col_left').style['padding-left'] = '10px'

            document.querySelectorAll('.footer_btm_area').forEach(e => {
                e.style.display = 'block'
            })
            document.querySelectorAll('.footer_copyright, .footer_payment_icon').forEach(e => {
                e.style['margin-top'] = '16px'
            })
            document.querySelectorAll('.product_item_list').forEach(e => {
                e.style['width'] = 'auto'
            })
            changeVisibility(['women', 'men'], false)

            changeVisibility(['service'], false)
        } else if (width <= 760) {
            document.querySelectorAll('.header_navbar').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.menu_list').forEach(e => {
                e.style.overflow = 'scroll'
                e.style.justifyContent = 'space-around'
            })

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['line-height'] = '80px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 20px';
            })

            document.querySelector('.col_left').style['padding-left'] = '10px'

            document.querySelectorAll('.footer_btm_area').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.footer_copyright, .footer_payment_icon').forEach(e => {
                e.style['margin-top'] = '0px'
            })

            changeVisibility(['service'], true)
            changeVisibility(['women', 'men'], false)

            if (document.querySelector('.sign_up')) {
                document.querySelector('.sign_up').style['margin-left'] = '0px'
                document.querySelector('.sign_up').style['margin-right'] = '10px'
            }
            document.querySelector('.col_left').style['padding-left'] = '10px'


            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '0px'
            })


            document.querySelectorAll('.pic>img').forEach(e => {
                e.style['height'] = 'auto'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 10px';
            })

            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'none'
            })
            document.querySelectorAll('.price_value').forEach(e => {
                e.style.padding = '10px'
            })
            document.querySelectorAll('.radio_value').forEach(e => {
                e.style.padding = '10px'
                e.style['margin-left'] = '10px'

            })
        } else {
            changeVisibility(['women', 'men'], true)
            //sign in-up
            if (document.querySelector('.sign_up')) {
                document.querySelector('.sign_up').style['margin-left'] = '50px'
                document.querySelector('.sign_up').style['margin-right'] = '20px'
            }
            document.querySelectorAll('.price_value').forEach(e => {
                e.style.padding = '5px'
            })
            document.querySelectorAll('.radio_value').forEach(e => {
                e.style.padding = '5px'
                e.style['margin-left'] = '0px'
            })

            document.querySelector('.col_left').style['padding-left'] = '0px'

            document.querySelectorAll('.menu_item').forEach(e => {
                e.style['margin'] = '1px'
            })

            document.querySelectorAll('.menu_item > a').forEach(e => {
                e.style['margin'] = '0px 20px'
            })

            document.querySelectorAll('.box_content').forEach(e => {
                e.style.display = 'flex'
            })
            document.querySelectorAll('.pic>img').forEach(e => {
                e.style['height'] = '382px'
            })
        }
    }

    window.addEventListener('resize', (window) => {
        const {clientWidth: width} = document.documentElement
        handleChangeWith(width)
    })

    console.log(document.documentElement.clientWidth)
    handleChangeWith(document.documentElement.clientWidth)

</script>

</body>

<style>
    @media only screen and (max-width: 635px) {
        .billing_details, .your_order {
            width: auto;
        }

        .radio_value {
            margin-left: 10px;
            margin-top: 10px;
        }

        .women, .men {
            display: block
        }
    }

</style>
</html>
