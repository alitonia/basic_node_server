<html lang="en">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="./assets/images/favicon/favicon.ico"/>
<link rel="stylesheet" href="./assets/css/admin_login/admin_login.css">
<link rel="stylesheet" href="./assets/css/base.css">
<link rel="stylesheet" href="./assets/css/home/main.css">
<link rel="stylesheet" href="./assets/css/home/slider.css">
<link rel="stylesheet" href="./assets/css/home/promo.css">
<link rel="stylesheet" href="./assets/css/home/product_area.css">
<link rel="stylesheet" href="./assets/css/home/footer.css">
<link rel="stylesheet" href="./assets/css/about_us/about_us.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">


<link rel="stylesheet" href="./assets/css/admin/general-header.css">
<link rel="stylesheet" href="./assets/css/admin/big-table.css">
<link rel="stylesheet" href="./assets/css/admin/tooltip.css">


<script src="./assets/js/admin/tokenManipulation.js"></script>
<script src="./assets/js/admin/immediateRedirect.js"></script>
<script src="./assets/js/admin/utils.js"></script>
<script src="./assets/js/admin/pagination.js"></script>


<head>
    <title>Admin - Products</title>
</head>

<body>

<div class="shop">
    <!-- Header -->
    <header class="header">
        <div class="grid">
            <div class="header_navbar">
                <a href="./home.html">
                    <div class="logo">
                        <img src="./assets/images/logo/logo.png" alt="logo">
                    </div>
                </a>

                <div class="menu_wrap">
                    <div class="main_menu">
                        <ul class="menu_list">
                            <li class="menu_item">
                                <a class="admin-panel-link link" href="./home.html">ADMIN PANEL</a>
                            </li>
                            <li class="menu_item">
                                <a class="orders-link link" href="./orders.html">ORDERS</a>
                            </li>
                            <li class="menu_item">
                                <a class="products-link link link-active" href="./products.html">PRODUCTS</a>
                            </li>
                            <li class="menu_item">
                                <a class="categories-link link" href="./categories.html">CATEGORIES</a>
                            </li>
                            <li class="menu_item">
                                <a class="customers-link link" href="./customers.html">CUSTOMERS</a>
                            </li>

                            <li class="menu_item">
                                <a class="logout-link link" href="#" onclick="logout()" style="color: #558776">LOG
                                    OUT</a>
                            </li>
                        </ul>
                    </div>

                </div>

            </div>
        </div>
    </header>
</div>

<div class="table-config">
    <div class="cart_page_area">
        <div class="cart_page_container">
            <div class="board-space" style="width:100%">

                <div class="addon-before-main-dish">
                    <div class="hyper-values">
                        <div class="display-box display-page-label">
                            <span class="display-prefix">Page: </span> <span
                                class="display-value display-page-label-value"></span>
                            <i class="fas fa-times close" onclick="resetPage()"></i>
                        </div>

                        <div class="display-box display-target-label">
                            <span class="display-prefix">Target: </span> <span
                                class="display-value display-target-label-value"></span>
                            <!--                        <i class="fas fa-times close"></i>-->
                        </div>

                        <div class="display-box display-sort-label">
                            <span class="display-prefix">Sort: </span> <span
                                class="display-value display-sort-label-value"></span>
                            <!--                        <i class="fas fa-times close"></i>-->
                        </div>

                        <div class="display-box display-search-label">
                            <span class="display-prefix">Search: </span> <span
                                class="display-value display-sort-label-value"></span> <i
                                class="fas fa-times close" onclick="resetSearch()"></i>
                        </div>
                    </div>

                    <div class="add-new-entry">
                        <button class="add-new-button action-button" onclick="handleAddNew()">Add New <i
                                class="fas fa-plus add-icon"></i></button>
                    </div>
                </div>

                <table class="styled-table">
                    <thead>
                    <tr>
                        <th class="t_id" onclick="openPopup('id')">Id <i class="fas fa-sort"></i></th>
                        <th class="t_customer_id" onclick="openPopup('name')">Product Name <i
                                class="fas fa-sort"></i></th>

                        <th class="t_customer_id" onclick="openPopup('description')">Description <i
                                class="fas fa-sort"></i></th>

                        <th class="t_send_email" onclick="openPopup('price')">Price <i
                                class="fas fa-sort"></i></th>
                        <th class="date" onclick="openPopup('current_stock')">Current Stock <i class="fas fa-sort"></i>
                        </th>
                        <th class="status" onclick="openPopup('bought')">Bought <i class="fas fa-sort"></i></th>

                        <th class="t_customer_id" onclick="openPopup('big_image_link')">Big Image Link <i
                                class="fas fa-sort"></i></th>

                        <th class="t_customer_id" onclick="openPopup('category_id')">Category ID<i
                                class="fas fa-sort"></i></th>

                        <th class="t_customer_id" onclick="openPopup('available')">Available <i
                                class="fas fa-sort"></i></th>

                        <th class="t_customer_id" onclick="openPopup('color_options')">Color Options <i
                                class="fas fa-sort"></i></th>
                        <th class="t_customer_id" onclick="openPopup('size_options')">Size Options <i
                                class="fas fa-sort"></i></th>


                        <th rowspan="3" class="action">Actions</th>
                    </tr>
                    </thead>

                    <tbody class="injectable-space">
                    </tbody>
                </table>


                <button class="stickyness" onclick="window.scrollTo(0,0);"><i class="fas fa-chevron-up icon-up"></i>
                </button>

                <div class="naviagte-buttons">
                    <div class="navigate-left">
                        <button class="control-button cb-left" onclick="toLastPage()"> <</button>
                    </div>
                    <div class="navigate-right">
                        <button class="control-button cb-right" onclick="toNextPage()"> ></button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<div class="popopen sortpop" onclick="closePopup()">
    <div class="popopen-content no-prop">
        <form class="popopen-form">
            <input type="hidden" name="field" class="target-field"/>

            <div class="major-sort">
                <label for="sort-value" class="sort-label first-sort-label">Sort By</label>
                <select name="sort-value" class="sort-choice">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>

            <div>
                <label for="search-value" class="search-label">Search For</label>
                <input type="text" name="search-value"/>
            </div>

            <div class="popup-buttons">
                <button type="button" onclick="closePopup()" class="action-button cancel-button">Close</button>
                <button type="submit" class="action-button view-button">Submit</button>
            </div>
        </form>
    </div>
</div>


<div class="popopen addpop" onclick="closePopup()">
    <div class="popopen-content no-prop long">
        <h4 class="popopen-title"><span class="pop-action">Edit</span> <span class="pop-target">product</span></h4>
        <form class="popopen-form" onkeydown="return event.key != 'Enter';">
            <input type="hidden" name="field" class="target-field"/>

            <input type="hidden" name="submit_type" class="p-submit_type" value="edit"/>

            <div class="entry product-id-entry">
                <label for="id" class="search-label align-label">Product ID</label>
                <input type="text" name="id" readonly class="p-id readonly-input"/>
            </div>

            <div class="entry">
                <label for="name" class="search-label align-label">Name</label>
                <input type="text" name="name" class="p-name" required/>
            </div>

            <div class="with-area entry">
                <label for="description" class="search-label align-label">Description</label>
                <textarea cols="30" rows="5" name="description" class="p-description t-ara" required></textarea>
            </div>

            <div class="entry">
                <label for="price" class="search-label align-label">Price</label>
                <input type="number" name="price" class="p-price" step="0.000001" min="0" required/>
            </div>

            <div class="entry">
                <label for="bought" class="search-label align-label">Bought</label>
                <input type="number" name="bought" class="p-bought" min="0" required/>
            </div>
            <div class="entry">
                <label for="current_stock" class="search-label align-label">Current Stock</label>
                <input type="number" name="current_stock" class="p-current_stock" min="0" required/>
            </div>

            <div class="entry sentry-looker">
                <label for="big_image_link" class="search-label align-label">Image</label>
                <div class="img-container">
                    <input type="file" name="big_image_link" class="p-big_image_link upload-zone-1 upload-input"
                           accept=".jpg, .jpeg, .png" title=""/>

                    <div class="preview upload-zone-1 upload-preview">
                        <p class="nothing-text"></p>
                    </div>
                </div>

            </div>

            <div class="entry">
                <label for="category_id" class="search-label align-label">Category Id</label>
                <select class="p-category_id sort-choice custom-choice" name="category_id" required>

                </select>
            </div>

            <div class="entry created-date-entry">
                <label for="created_date" class="search-label align-label">Created Date</label>
                <input type="text" name="created_date" class="p-created_date readonly-input" readonly=""/>
            </div>

            <div class="entry">
                <label for="available" class="search-label align-label">Available</label>
                <select type="text" name="available" class="p-available sort-choice custom-choice" required>
                    <option value="true">True</option>
                    <option value="False">False</option>
                </select>
            </div>


            <div class="with-area entry">
                <label for="address" class="search-label align-label">Address</label>
                <textarea cols="30" rows="5" name="address" class="p-address t-ara" required></textarea>
            </div>

            <div class="with-area entry">
                <label for="color_options" class="search-label align-label">Color Option</label>
                <div class="grand-container">
                    <input type="hidden" name="color_options" class="p-color_options"/>
                    <span class="color_zone consec-button-zone"></span>
                    <input type="text" name="color-adder"
                           class="additional-add-color-input additional-adder"
                           placeholder="Add new Color"/>
                </div>
            </div>

            <div class="with-area entry">
                <label for="size_options" class="search-label align-label">Size Option</label>
                <div class="grand-container">
                    <input type="hidden" name="size_options" class="p-size_options"/>
                    <span class="size_zone consec-button-zone"></span>
                    <input type="text" name="color-adder"
                           class="additional-add-size-input additional-adder"
                           placeholder="Add new Size"/>
                </div>
            </div>

            <div class="popup-buttons">
                <button type="button" onclick="closePopup()" class="action-button cancel-button">Close</button>
                <button type="submit" class="action-button view-button">Submit</button>
            </div>
        </form>
    </div>
</div>


<script>
    const PAGE_SIZE = 30
    const path = '/admin/products'

    let savedProducts = null

    async function getProducts(sortby = 'name', order = 'asc', page = 0, searchby = '') {
        return fetch(`${path}?sortby=${sortby}&order=${order}&offset=${page * PAGE_SIZE}&limit=${PAGE_SIZE}${searchby ? `&searchby=${searchby}` : ''}`, {
            method: 'GET', // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        }).then(x => {
            //TODO: fix this
            if (x.status >= 400) {
                if (x.status === 401) {
                    //unauthorized. Maybe out of session
                    deleteCookie1()
                    alert('Your session has ended. Please log in again')
                    document.location.replace('./login.html')
                }
                throw new Error(x.statusText)
            }
            return x.json()
        }).catch(err => {
            alert(err.toString())
            return null
        })
    }

    async function start(sortby = 'name', order = 'asc', page = 0, searchby = '', target) {
        if (!isLogin) {
            return;
        }
        if (getParam('page', 0) == 0) {
            document.querySelector('.cb-left').style.display = 'none'
        }

        const products = await getProducts(sortby, order, page, searchby)
        if (!products) {
            return;
        }
        savedProducts = products

        const injectSpace = document.querySelector('.injectable-space')
        const space = document.querySelector('.board-space')

        if (products.length < PAGE_SIZE) {
            document.querySelector('.cb-right').style.display = 'none'
        }

        if (products.length === 0) {
            // space.innerHTML = (`
            //     <h4 style="font-size: 20px">Orders are empty</h4>
            // `)
        } else {
            injectSpace.innerHTML = (`
                ${products.reduce((acc, cur) => {
                const {
                    id,
                    name,
                    description,
                    full_description,
                    price,
                    bought,
                    current_stock,
                    big_image_link,
                    image_links = '',
                    category_id,
                    created_date,
                    available,
                    rating,
                    total_rated,
                    address,
                    color_options,
                    size_options,
                    status = ''
                } = cur

                const notAvailable = (available === false || current_stock === 0)
                const lowlight = notAvailable

                const highlight = false

                const goodlight = false
                const queerlight = false

                const blurrylight = false

                const canView = available === true;
                const canDelete = available === true
                const canRestore = !canDelete
                const canEdit = available === true
                const canSetDelivered = false

                const imgLink = `${window.location.origin}/${big_image_link}`
                const product_link = `${window.location.origin}/product.html?product_id=${id}`

                const colorSpans = tryParse(color_options, []).sort().reduce((acc, c) => {
                    return `${acc} <div class="small-entry tooltip">
                        ${c}
                        <span class="tooltiptext gentle-longness sample-color-preview"
                        style="background: ${c}"></span>
                        </div>`
                }, '')

                const sizeSpans = tryParse(size_options, []).sort().reduce((acc, c) => {
                    return `${acc} <div class="small-entry">${c}</div>`
                }, '')

                return acc + `
                    <tr class="${blurrylight ? 'blurry-row' : ''} ${`entity-id-${id || ''}`} ${highlight ? 'active-row' : 'normal-row'} ${lowlight ? 'bad-row' : ''} ${goodlight ? 'good-row' : ''} ${queerlight ? 'queer-row' : ''}">
                    <td>${!notAvailable ? `<a href="${product_link}" target="_blank" style="font-weight: 500;">${id}</a>` : `${id}`}</td>
                    <td>${name}</td>

                    <td>
                    <span class="tooltip">
                    <p class="description-text">${description}
                    </p>
                    <span class="tooltiptext gentle-longness">${description}</span>
                    </span>
                    </td>

                    <td>${price.toFixed(3)}</td>
                    <td>${current_stock}</td>
                    <td>${bought}</td>

                    <td><span class=" tooltip">
                    <a href="${imgLink}" target="_blank" style="font-weight: 500;">${big_image_link}</a>
                    <span class="tooltiptext freedom-img"><img src="${imgLink}" alt="big link"></span>
                    </span></td>

                    <td><a href="./categories.html?sortby=id&searchValue=${category_id}&target=${category_id}">${category_id}</a></td>
                    <td>${available}</td>

                    <td class="color-entry">${colorSpans}</td>

                    <td class="size-entry">${sizeSpans}</td>
                    <td>
                    <div class="button-holder">
                    ${canView ? `<button class="action-button view-button" onclick="handleView(${id})">View Raw</button>` : ''}
                    ${canRestore ? `<button class="action-button revert-button" onclick="handleRestore(${id})">Restore</button>` : ''}
                    ${canDelete ? `<button class="action-button cancel-button" onclick="handleDelete(${id})">Delete</button>` : ''}
                    ${canEdit ? `<button class="action-button accept-button" onclick="handleEdit(${id})">Edit</button>` : ''}
                    </div>
                    </td>
                    </tr>
                    `;

            }, '')}
`)
            if (target) {
                const mayScrollToElement = document.querySelector(`.entity-id-${target}`)
                if (mayScrollToElement) {
                    mayScrollToElement.scrollIntoView()
                }
            }
        }
    }

    function displayOrRemove(field, value) {
        if (!value || value === "0") {
            document.querySelector(`.${field}`).style.display = 'none'
        } else {
            document.querySelector(`.${field} .display-value`).innerText = value
        }
    }

    const current_url = new URL(window.location.href)
    const sortby = current_url.searchParams.get('sortby') || 'name'
    const order = current_url.searchParams.get('order') || 'asc'
    const page = current_url.searchParams.get('page') || 0
    const searchby = current_url.searchParams.get('searchValue') || 0

    const target = getParam('target', null)


    displayOrRemove('display-page-label', page)
    displayOrRemove('display-target-label', sortby)
    displayOrRemove('display-sort-label', order)
    displayOrRemove('display-search-label', searchby)

    start(sortby, order, page, searchby, target);

</script>

<script>
    async function productModificationRequest(id, fields, method = 'PUT') {
        return fetch('/admin/products', {
            method: method, // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
            body: JSON.stringify({
                id: id,
                ...fields
            })
        }).then(x => {
            if (x.status === 401) {
                //unauthorized. Maybe out of session
                deleteCookie1()
                alert('Your session has ended. Please log in again')
                document.location.replace('./login.html')
            }
            if (x.status === 401) {
                //unauthorized. Maybe out of session
                deleteCookie1()
                alert('Your session has ended. Please log in again')
                document.location.replace('./login.html')
            }

            return x.json()
        })
            .then((x) => {
                if (x && x.error) {
                    throw new Error(x.error)
                } else {
                    reload(x.id)
                }
            })
            .catch(err => {
                alert(err.message)
                console.warn(err)
                return null
            })
    }

    async function updateProduct(id, fields) {
        return productModificationRequest(id, fields, 'PUT')
    }

    async function addAProduct(id, fields) {
        return productModificationRequest(id, fields, 'POST')
    }

    function injectProductPopup(className, value) {
        document.querySelector(`.popopen.addpop .${className}`).value = value
    }

    function injectProductPopupClass(className, value, remove = false) {
        const classList = value.split(' ')
        const target = document.querySelector(`.popopen.addpop .${className}`)

        classList.forEach(c => {
            if (remove) {
                target.classList.remove(c)
            } else {
                target.classList.add(c)
            }
        })
    }

    function injectProductPopupProps(className, props) {
        const propList = Object.entries(props)
        const target = document.querySelector(`.popopen.addpop .${className}`)

        propList.forEach(p => {
            const [k, v] = p
            target[k] = v
        })
    }

    function injectProductPopupStyle(className, props) {
        const propList = Object.entries(props)
        const target = document.querySelector(`.popopen.addpop .${className}`)

        propList.forEach(p => {
            const [k, v] = p
            target.style[k] = v
        })
    }


    const handleEdit = (id) => {
        const target = savedProducts.find(p => p.id === id)
        const {
            name,
            description,
            price,
            bought,
            current_stock,
            big_image_link,
            category_id,
            created_date,
            available,
            address,
            color_options,
            size_options,
        } = target

        injectProductPopup('p-submit_type', 'edit')
        injectProductPopupProps('pop-action', {innerText: 'Edit'})

        injectProductPopup('p-id', id)
        injectProductPopupStyle('product-id-entry', {display: 'flex'})


        injectProductPopup('p-name', name)
        injectProductPopup('p-description', description)
        injectProductPopup('p-price', price.toFixed(6))
        injectProductPopup('p-bought', bought)

        injectProductPopup('p-current_stock', current_stock)

        injectProductPopup('p-big_image_link', null)
        injectProductPopupProps('p-big_image_link', {required: false})
        clearChild('.upload-zone-1.upload-preview')
        injectImageToPreview(big_image_link)

        injectProductPopup('p-category_id', category_id)

        injectProductPopup('p-created_date', created_date)
        injectProductPopupStyle('created-date-entry', {display: 'flex'})


        injectProductPopup('p-address', address)
        injectProductPopup('p-available', available)

        // start size processing
        const size_op = tryParse(size_options, [])

        injectProductPopup('p-size_options', size_options)
        clearChild('.size_zone')

        size_op.forEach(s => {
            const button = document.createElement('button')

            const idButton = Math.random().toString()
            button.classList.add(idButton)

            const deleteSelfIcon = document.createElement('i')
            deleteSelfIcon.classList.add('fas')
            deleteSelfIcon.classList.add('close')
            deleteSelfIcon.classList.add('fa-times')
            deleteSelfIcon.classList.add('small-close')

            deleteSelfIcon.onclick = () => {
                if (window.confirm(`Are you sure you want to delete size ${s}?`)) {
                    button.parentNode.removeChild(button)
                    const newValue = tryParse(document.querySelector('.p-size_options').value, [])
                        .filter(x => x !== s)

                    document.querySelector('.p-size_options').value = JSON.stringify(newValue)
                }
            }

            button.type = 'button'
            button.innerText = s

            button.classList.add('display-box')
            button.classList.add('display-page-label')
            button.classList.add('remove-able-button')
            // button.style.background = s

            button.onclick = () => {
                // console.log(s)
            }
            button.appendChild(deleteSelfIcon)

            button.onmouseenter = () => {
                // button.style.background = 'black'
            }

            button.onmouseleave = () => {
                // button.style.background = s
            }

            document.querySelector('.size_zone').appendChild(button)
        })

        // start size processing
        const color_op = tryParse(color_options, [])

        injectProductPopup('p-color_options', color_options)
        clearChild('.color_zone')

        color_op.forEach(c => {
            const button = document.createElement('button')

            const idButton = Math.random().toString()
            button.classList.add(idButton)

            const deleteSelfIcon = document.createElement('i')
            deleteSelfIcon.classList.add('fas')
            deleteSelfIcon.classList.add('close')
            deleteSelfIcon.classList.add('fa-times')
            deleteSelfIcon.classList.add('small-close')

            deleteSelfIcon.onclick = () => {
                if (window.confirm(`Are you sure you want to delete color ${c}?`)) {
                    button.parentNode.removeChild(button)
                    const newValue = tryParse(document.querySelector('.p-color_options').value, [])
                        .filter(x => x !== c)

                    document.querySelector('.p-color_options').value = JSON.stringify(newValue)
                }
            }

            button.type = 'button'
            button.innerText = c

            button.classList.add('display-box')
            button.classList.add('display-page-label')
            button.classList.add('remove-able-button')
            button.style.background = c

            button.onclick = () => {
                // console.log(c)
            }
            button.appendChild(deleteSelfIcon)

            button.onmouseenter = () => {
                button.style.background = 'black'
            }

            button.onmouseleave = () => {
                button.style.background = c
            }

            document.querySelector('.color_zone').appendChild(button)
        })

        document.querySelectorAll('.additional-adder').forEach(e => {
            e.value = ''
        })

        openAddPop('')
    }
    const handleDelete = (id) => {
        updateProduct(id, {'available': false})

    }

    const handleRestore = (id) => {
        updateProduct(id, {'available': true})
    }

    const handleView = (id) => {
        openNewTab(`${window.location.origin}/product/${id}`)
    }
</script>

<script>
    function closePopup() {
        document.querySelectorAll('.popopen').forEach(e => {
            e.classList.remove('active')
        })
    }

    function openPopup(id, specific = 'sortpop') {
        closePopup()

        document.querySelectorAll(`.popopen.${specific}`).forEach(e => {
            e.classList.add('active')
        })

        document.querySelectorAll(`.popopen.${specific} .target-field`).forEach(e => {
            e.value = id || ''
        })
    }

    function openAddPop(id) {
        openPopup(id, 'addpop')
    }


    function processForm(e) {
        // console.log('here')
        if (e.preventDefault) {
            e.preventDefault();
        }
        const formData = new FormData(e.target)
        const sortby = formData.get('field')
        const sortValue = formData.get('sort-value')
        const searchValue = formData.get('search-value') || ""

        changePage(url_mutation({sortby: sortby, order: sortValue, page: 0, searchValue: searchValue, target: ''}))
        return false
    }

    const form = document.querySelector('.popopen.sortpop .popopen-form');
    if (form.attachEvent) {
        form.attachEvent("submit", processForm);
    } else {
        form.addEventListener("submit", processForm);
    }
</script>

<script>
    function resetPage() {
        changePage(removeParam('target', removeParam('page', window.location.href)))
    }

    function resetSearch() {
        changePage(removeParam('target', removeParam('searchValue', window.location.href)))
    }
</script>

<script src="./assets/js/admin/popupProp.js"></script>

<script>
    const upload_input = document.querySelector('.upload-zone-1.upload-input')
    const upload_display_zone = document.querySelector('.upload-zone-1.upload-preview')

    function clearChild(selector) {
        const x = document.querySelector(selector)
        if (x) {
            while (x.firstChild) {
                x.removeChild(x.firstChild);
            }
        }
    }

    function injectImageToPreview(src) {
        const image = document.createElement('img');
        image.classList.add('upload-img-preview-holder')
        image.src = window.location.origin + '/' + src
        upload_display_zone.appendChild(image);
    }

    function updateImageDisplay() {
        while (upload_display_zone.firstChild) {
            upload_display_zone.removeChild(upload_display_zone.firstChild);
        }

        const curFiles = upload_input.files;

        if (curFiles.length === 0) {
            const para = document.createElement('p');
            para.classList.add('nothing-text')
            para.textContent = '';
            upload_display_zone.appendChild(para);
        } else {
            const file = curFiles[0]
            const para = document.createElement('p');
            if (validFileType(file)) {
                const sizeInKB = returnFileSizeInKB(file.size)
                // console.log(sizeInKB)
                const isTooBig = sizeInKB > maxUploadSize
                if (isTooBig) {
                    para.classList.add('danger-file-size')
                }
                para.classList.add('something-text')
                para.textContent = `   ${returnFileSizeString(file.size)} ${isTooBig ? `File too large. Max file size is ${maxUploadSize}KB.` : ''}`;
                const image = document.createElement('img');
                image.classList.add('upload-img-preview-holder')
                image.src = URL.createObjectURL(file);
                upload_display_zone.appendChild(image);
            } else {
                para.classList.add('nothing-text')
                para.textContent = '';
            }
            upload_display_zone.appendChild(para);
        }
    }

    upload_input.addEventListener('change', updateImageDisplay);


    function addToColors(e) {
        const isSubmit = e.key === 'Enter'

        if (isSubmit) {
            const input = document.querySelector('.additional-add-color-input.additional-adder')
            const value = input.value.toString().trim()

            if (isColor(value)) {
                const oldColorsInput = document.querySelector('.p-color_options')
                const pOb = tryParse(oldColorsInput.value, [])

                if (pOb.map(k => k.toLowerCase()).includes(value.toLowerCase())) {
                    alert('Value already existed!')
                    return;
                }

                const newValue = JSON.stringify(pOb.concat(value))
                // console.log(newValue)
                oldColorsInput.value = newValue

                const button = document.createElement('button')

                const idButton = Math.random().toString()
                button.classList.add(idButton)

                const deleteSelfIcon = document.createElement('i')
                deleteSelfIcon.classList.add('fas')
                deleteSelfIcon.classList.add('close')
                deleteSelfIcon.classList.add('fa-times')
                deleteSelfIcon.classList.add('small-close')

                deleteSelfIcon.onclick = () => {
                    if (window.confirm(`Are you sure you want to delete color ${value}?`)) {
                        button.parentNode.removeChild(button)
                        const newValue = tryParse(document.querySelector('.p-color_options').value, [])
                            .filter(x => x !== value)

                        document.querySelector('.p-color_options').value = JSON.stringify(newValue)
                    }
                }

                button.type = 'button'
                button.innerText = value

                button.classList.add('display-box')
                button.classList.add('display-page-label')
                button.classList.add('remove-able-button')
                button.style.background = value

                button.onclick = () => {
                    // console.log(value)
                }
                button.appendChild(deleteSelfIcon)

                button.onmouseenter = () => {
                    button.style.background = 'black'
                }

                button.onmouseleave = () => {
                    // console.log(value)
                    button.style.background = value
                }

                document.querySelector('.color_zone').appendChild(button)
                input.value = ''
            } else {
                alert('Not a valid color')
            }
        }
    }

    function addToSizes(e) {
        const isSubmit = e.key === 'Enter'

        if (isSubmit) {
            const input = document.querySelector('.additional-add-size-input.additional-adder')
            const value = input.value.toString().trim()

            const oldSizesInput = document.querySelector('.p-size_options')
            const pOb = tryParse(oldSizesInput.value, [])
            if (pOb.map(k => k.toLowerCase()).includes(value.toLowerCase())) {
                alert('Value already existed!')
                return;
            }

            const newValue = JSON.stringify(pOb.concat(value))
            // console.log(newValue)
            oldSizesInput.value = newValue

            const button = document.createElement('button')

            const idButton = Math.random().toString()
            button.classList.add(idButton)

            const deleteSelfIcon = document.createElement('i')
            deleteSelfIcon.classList.add('fas')
            deleteSelfIcon.classList.add('close')
            deleteSelfIcon.classList.add('fa-times')
            deleteSelfIcon.classList.add('small-close')

            deleteSelfIcon.onclick = () => {
                if (window.confirm(`Are you sure you want to delete size ${value}?`)) {
                    button.parentNode.removeChild(button)
                    const newValue = tryParse(document.querySelector('.p-size_options').value, [])
                        .filter(x => x !== value)

                    document.querySelector('.p-size_options').value = JSON.stringify(newValue)
                }
            }

            button.type = 'button'
            button.innerText = value

            button.classList.add('display-box')
            button.classList.add('display-page-label')
            button.classList.add('remove-able-button')
            // button.style.background = s

            button.onclick = () => {
                // console.log(value)
            }
            button.appendChild(deleteSelfIcon)

            button.onmouseenter = () => {
                // button.style.background = 'black'
            }

            button.onmouseleave = () => {
                // button.style.background = s
            }

            document.querySelector('.size_zone').appendChild(button)
            input.value = ''

        }
    }

    document.querySelector('.additional-add-color-input.additional-adder').addEventListener('keyup', addToColors)

    document.querySelector('.additional-add-size-input.additional-adder').addEventListener('keyup', addToSizes)

</script>

<script>
    async function getAllCategories() {
        return fetch('/admin/categories?is_short=true', {
            method: 'GET', // *GET, POST, PUT, DELETE, etc.
            mode: 'same-origin', // no-cors, *cors, same-origin
            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `bearer ${token}`
            },
            redirect: 'follow', // manual, *follow, error
            referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
        }).then(x => {
            if (x.status === 401) {
                //unauthorized. Maybe out of session
                deleteCookie1()
                alert('Your session has ended. Please log in again')
                document.location.replace('./login.html')
            }
            return x.json()
        })
            .then(x => {
                if (x && x.error) {
                    throw new Error(x.error)
                }
                return x
            })
            .catch(err => {
                alert(err.message)
                console.warn(err)
                return null
            })
    }

    async function completeFormCategoryChoice() {
        const categories = await getAllCategories()
        if (categories === null || categories.length === 0) {
            return;
        }

        clearChild('.p-category_id')
        const p = document.querySelector('.p-category_id')

        categories.forEach(c => {
            const entry = document.createElement('option')
            entry.value = c.id;
            entry.innerText = c.id
            entry.classList.add('category-id-possible-value')
            p.appendChild(entry)
        })
    }

    completeFormCategoryChoice()
</script>

<script>
    const maxUploadSize = 200 //KB


    function readFileContent(file, callback) {
        const fileReader = new FileReader();
        fileReader.onloadend = function () {
            callback(fileReader.result);
        }
        fileReader.readAsDataURL(file);
    }

    function handleSubmitProductForm(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }

        const formData = new FormData(e.target)

        const submit_type = formData.get('submit_type')
        // console.log(submit_type)

        const isEdit = submit_type === 'edit'
        const isAdd = !isEdit

        const reqBody = {}

        const allowedFields = [
            'name', 'description',
            'price', 'bought',
            'current_stock',
            'big_image_link',
            'category_id', 'available', 'address',
            'color_options', 'size_options'
        ]

        const color_options = formData.get('color_options')
        const size_options = formData.get('size_options')

        if (tryParse(color_options, []).length === 0) {
            alert('Product needs at least 1 color')
            return false;
        }

        if (tryParse(size_options, []).length === 0) {
            alert('Product needs at least 1 size')
            return false;
        }


        for (const pair of formData.entries()) {
            if (allowedFields.includes(pair[0])) {
                reqBody[pair[0]] = pair[1]
            }
        }

        const uploadedFile = formData.get('big_image_link')
        const fileSize = returnFileSizeInKB(uploadedFile.size)
        // console.log(fileSize)

        if (fileSize > maxUploadSize) {
            alert(`Your image is too large. Max upload file size is ${maxUploadSize}KB`)
            return false
        }

        const id = formData.get('id')

        if (!id && isEdit) {
            alert('Id is empty')
            return false;
        }

        const type = reqBody['big_image_link'].type
        const allowedType = /^image\/(png|jpe?g)$/

        // console.log(type)

        const isImageNotChange = reqBody['big_image_link'] && reqBody['big_image_link'].size === 0

        if (!allowedType.test(type) && !isImageNotChange) {
            alert('Invalid file type. Expect jpg/jpeg/png.')
            return false;
        }

        readFileContent(reqBody['big_image_link'], (file) => {
            if (!isImageNotChange) {
                reqBody['big_image_link_type'] = type
                reqBody['big_image_link'] = file
            } else {
                reqBody['big_image_link'] = ''
            }
            if (isEdit) {
                updateProduct(id, reqBody)
            } else {
                addAProduct(id, reqBody)
            }
        })

        return false
    }

    const productForm = document.querySelector('.popopen.addpop .popopen-form');
    if (productForm.attachEvent) {
        productForm.attachEvent("submit", handleSubmitProductForm);
    } else {
        productForm.addEventListener("submit", handleSubmitProductForm);
    }
</script>

<script type="text/javascript">

    function handleAddNew() {

        injectProductPopup('p-submit_type', 'add')
        injectProductPopupProps('pop-action', {innerText: 'Add new'})


        injectProductPopup('p-id', '')
        injectProductPopupStyle('product-id-entry', {display: 'none'})


        injectProductPopup('p-name', '')
        injectProductPopup('p-description', '')
        injectProductPopup('p-price', '')
        injectProductPopup('p-bought', '')

        injectProductPopup('p-current_stock', '')

        injectProductPopup('p-big_image_link', null)
        injectProductPopupProps('p-big_image_link', {required: true})

        clearChild('.upload-zone-1.upload-preview')

        injectProductPopup('p-category_id', '')

        injectProductPopup('p-created_date', '')
        injectProductPopupStyle('created-date-entry', {display: 'none'})


        injectProductPopup('p-address', '')
        injectProductPopup('p-available', true)

        // start size processing
        injectProductPopup('p-size_options', JSON.stringify([]))
        clearChild('.size_zone')

        // start size processing
        injectProductPopup('p-color_options', JSON.stringify([]))
        clearChild('.color_zone')


        document.querySelectorAll('.additional-adder').forEach(e => {
            e.value = ''
        })

        openAddPop('')
    }
</script>

</body>

<style>
    .styled-table th, .styled-table td {
        padding: 12px 3px;
    }

    .description-text {
        max-width: 50px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }

    .color-entry {
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
        min-height: 100px;
    }

    .small-entry {
        padding-bottom: 3px;
    }

</style>

</html>